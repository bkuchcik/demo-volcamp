version: '3.1'

services:

  mongo:
    image: mongo
    restart: always
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: powerapi
    volumes:
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
  
  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: example

  powerapi-sensor:
    image: powerapi/hwpc-sensor
    command: -n fabriksensor -r "mongodb" -U mongodb://root:example@mongo:27017 -D powerapi -C sensor -s "rapl" -o -e RAPL_ENERGY_PKG
    privileged: true
    volumes:
      - /sys:/sys
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /tmp/powerapi-sensor-reporting:/reporting powerapi/hwpc-sensor
    depends_on:
      - mongo

  powerapi-formula:
    image: powerapi/rapl-formula
    command: -s --input mongodb -u mongodb://root:example@mongo:27017 -d powerapi -c sensor --output influxdb --uri influxdb --port 8086 --db power_consumption --name grafana_output
    depends_on:
      - influxdb
      - mongo

  grafana:
    image: grafana/grafana
    ports:
      - 80:3000

  influxdb:
    image: influxdb
    environment:
     DOCKER_INFLUXDB_INIT_USERNAME: root
     DOCKER_INFLUXDB_INIT_PASSWORD: example
     DOCKER_INFLUXDB_INIT_ORG: powerapi
     DOCKER_INFLUXDB_INIT_BUCKET: power_consumption


